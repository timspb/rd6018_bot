# üîã RD6018 Telegram Controller

> **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–º –±–ª–æ–∫–æ–º –ø–∏—Ç–∞–Ω–∏—è RD6018 —á–µ—Ä–µ–∑ Home Assistant**

[![Python](https://img.shields.io/badge/Python-3.9+-blue?style=flat-square&logo=python)](https://www.python.org/)
[![aiogram](https://img.shields.io/badge/aiogram-3.x-green?style=flat-square)](https://docs.aiogram.dev/)
[![Home Assistant](https://img.shields.io/badge/Home%20Assistant-REST%20API-blueviolet?style=flat-square&logo=home-assistant)](https://www.home-assistant.io/)

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram-–±–æ—Ç —Å –µ–¥–∏–Ω—ã–º –¥–∞—à–±–æ—Ä–¥–æ–º: –≥—Ä–∞—Ñ–∏–∫ U/I, –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DeepSeek –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–∏–≤–æ–π –∑–∞—Ä—è–¥–∞.

---

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| **üìä –î–∞—à–±–æ—Ä–¥** | –û–¥–∏–Ω message —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è/—Ç–æ–∫–∞, –∂–∏–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏ inline-–∫–Ω–æ–ø–∫–∞–º–∏ |
| **üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** | –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ —Å–ø–∞–º–∞ (—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ message) |
| **üîã –ü—Ä–æ—Ñ–∏–ª–∏ –∑–∞—Ä—è–¥–∞** | Ca/Ca, EFB, AGM ‚Äî –≤—ã–±–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è, –≤–≤–æ–¥ —ë–º–∫–æ—Å—Ç–∏ (–ê—á), –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ü–∏–∫–ª (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚Üí Main ‚Üí –î–µ—Å—É–ª—å—Ñ–∞—Ç–∞—Ü–∏—è ‚Üí Mix ‚Üí Done) |
| **‚ö° –í–ö–õ/–í–´–ö–õ** | –í–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ RD6018 —á–µ—Ä–µ–∑ Home Assistant |
| **üìà –õ–æ–≥–∏** | –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ V/I –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| **üß† AI –ê–Ω–∞–ª–∏–∑** | DeepSeek —Å ¬´–ø–∞–º—è—Ç—å—é¬ª: –∏—Å—Ç–æ—Ä–∏—è –∑–∞ 180 –º–∏–Ω, —Ç—Ä–µ–Ω–¥ U/I, —Å—Ç–∞–¥–∏—è CC/CV/Float, –ø—Ä–æ–≥–Ω–æ–∑ –∏ –æ—Ü–µ–Ω–∫–∞ Lead-Acid |
| **üå° –¢–µ–ø–ª–æ–≤–∞—è –∑–∞—â–∏—Ç–∞** | –ü—Ä–∏ T > 45¬∞C ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ –∏ –∞–ª–µ—Ä—Ç –≤ Telegram |
| **üìâ –ò—Å—Ç–æ—Ä–∏—è** | SQLite: —Ö—Ä–∞–Ω–µ–Ω–∏–µ V/I/P/T –∫–∞–∂–¥—ã–µ 30 —Å –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ |
| **üîî –ú–æ–Ω–∏—Ç–æ—Ä –∑–∞—Ä—è–¥–∞** | –§–æ–Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω: –∞–ª–µ—Ä—Ç –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞—Ä—è–¥–∞ (I<0.1–ê, U‚â•13.5–í); –∞–ª–µ—Ä—Ç –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏ 30+ –º–∏–Ω |

---

## üõ† –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

- **aiogram 3.x** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram Bot API
- **aiohttp** ‚Äî –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Home Assistant
- **aiosqlite** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å SQLite
- **matplotlib** ‚Äî –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞)
- **python-dotenv** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ `.env`

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
rd6018_bot/
‚îú‚îÄ‚îÄ bot.py           # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, handlers, –¥–∞—à–±–æ—Ä–¥, data_logger, charge_monitor
‚îú‚îÄ‚îÄ config.py        # –¢–æ–∫–µ–Ω—ã, ENTITY_MAP, –ª–∏–º–∏—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ database.py      # aiosqlite: sensor_history, charge_sessions, charge_log
‚îú‚îÄ‚îÄ hass_api.py      # HassClient: get_state, set_value, turn_on/off
‚îú‚îÄ‚îÄ graphing.py      # generate_chart() ‚Äî dual-axis U/I –≥—Ä–∞—Ñ–∏–∫
‚îú‚îÄ‚îÄ charge_logic.py  # ChargeController: State Machine (Ca/Ca, EFB, AGM)
‚îú‚îÄ‚îÄ ai_engine.py     # ask_deepseek() ‚Äî –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏–≤–æ–π –∑–∞—Ä—è–¥–∞
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ README.md
```

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
git clone <repo_url>
cd rd6018_bot

pip install -r requirements.txt
```

### 2. –§–∞–π–ª `.env`

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# Telegram (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
TG_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
# –∏–ª–∏ TELEGRAM_BOT_TOKEN=...

# Home Assistant
HA_URL=http://192.168.1.100:8123
HA_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# DeepSeek (–¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞)
DEEPSEEK_API_KEY=sk-...
DEEPSEEK_BASE_URL=https://api.deepseek.com
```

### 3. –ó–∞–ø—É—Å–∫

```bash
python bot.py
```

---

## üì° Home Assistant: –º–∞–ø–ø–∏–Ω–≥ —Å—É—â–Ω–æ—Å—Ç–µ–π

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ entity ID (–¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ HA):

| –ö–ª—é—á | Entity ID |
|------|-----------|
| voltage | `sensor.rd_6018_output_voltage` |
| current | `sensor.rd_6018_output_current` |
| power | `sensor.rd_6018_output_power` |
| ah | `sensor.rd_6018_battery_charge` |
| wh | `sensor.rd_6018_battery_energy` |
| temp_int | `sensor.rd_6018_temperature` |
| temp_ext | `sensor.rd_6018_temperature_external` |
| is_cv | `binary_sensor.rd_6018_constant_voltage` |
| is_cc | `binary_sensor.rd_6018_constant_current` |
| switch | `switch.rd_6018_output` |
| set_voltage | `number.rd_6018_output_voltage` |
| set_current | `number.rd_6018_output_current` |

---

## üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å

### –ö–æ–º–∞–Ω–¥—ã

- `/start` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ RD6018

### –î–∞—à–±–æ—Ä–¥ (—Ç–µ–∫—Å—Ç)

```
üìä –°–¢–ê–¢–£–°: –í–ö–õ | CV
‚ö° LIVE:    14.40–í | 5.00–ê | 72.00–í—Ç
üéØ –¶–ï–õ–¨:    14.40–í | 10.0–ê
üîã –ï–ú–ö–û–°–¢–¨: 25.50 –ê—á | 290.1 –í—Ç—á
üå° –¢–ï–ú–ü:    21.0¬∞C (–í–Ω–µ—à) | 39.0¬∞C (–í–Ω—É—Ç—Ä)
```

### –ö–Ω–æ–ø–∫–∏

- **‚öôÔ∏è –†–µ–∂–∏–º—ã –∑–∞—Ä—è–¥–∞** ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–º–µ–Ω—é ¬´üöó –ê–≤—Ç–æ¬ª (Ca/Ca, EFB, AGM) —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –æ 16.5–í
- **üîÑ –û–±–Ω–æ–≤–∏—Ç—å** ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞—à–±–æ—Ä–¥
- **üìà –õ–æ–≥–∏** ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π U/I/–¢–µ–º–ø –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü—ã (–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç: –í—Ä–µ–º—è | –ù–∞–ø—Ä—è–∂. | –¢–æ–∫ | –¢–µ–º–ø)
- **üß† AI –ê–Ω–∞–ª–∏–∑** ‚Äî –∑–∞–ø—Ä–æ—Å –∫ DeepSeek –ø–æ –∏—Å—Ç–æ—Ä–∏–∏
- **üõë –í–´–ö–õ** / **‚ö° –í–ö–õ** ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞
- **üõë –û–°–¢–ê–ù–û–í–ò–¢–¨ –ó–ê–†–Ø–î** ‚Äî —Å–±—Ä–æ—Å ChargeController –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞ (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –∑–∞—Ä—è–¥–µ)

---

## üîã ChargeController: –ø—Ä–æ—Ñ–∏–ª–∏ –∑–∞—Ä—è–¥–∞

| –ü—Ä–æ—Ñ–∏–ª—å | Main | –î–µ—Å—É–ª—å—Ñ–∞—Ç–∞—Ü–∏—è | Mix Mode |
|---------|------|---------------|----------|
| **Ca/Ca** | 14.7V/0.5C | 16.3V/2%Ah –ø—Ä–∏ I>0.3A | 16.5V/3%Ah, Delta V/I |
| **EFB** | 14.8V/0.5C | –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ | 16.5V/3%Ah, –¥–æ 10—á |
| **AGM** | 14.4‚Üí14.6‚Üí14.8‚Üí15.0V (—Å—Ç—É–ø–µ–Ω–∏) | ‚Äî | 16.3V/2%Ah, Delta V/I |

–í—ã—Ö–æ–¥ –ø–æ Delta V: V —É–ø–∞–ª–æ –Ω–∞ 0.03V –æ—Ç –ø–∏–∫–∞. –í—ã—Ö–æ–¥ –ø–æ Delta I: I –≤—ã—Ä–æ—Å–ª–æ –Ω–∞ 0.03A –æ—Ç –º–∏–Ω–∏–º—É–º–∞. –¢–µ–ø–ª–æ–≤–∞—è –∑–∞—â–∏—Ç–∞: T>45¬∞C –∏–ª–∏ +2¬∞C –∑–∞ 5 –º–∏–Ω.

---

## üîî –§–æ–Ω–æ–≤—ã–π –º–æ–Ω–∏—Ç–æ—Ä –∑–∞—Ä—è–¥–∞

–ó–∞–¥–∞—á–∞ `charge_monitor` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∏—è –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç:

| –£—Å–ª–æ–≤–∏–µ | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |
|---------|-------------|
| `I < 0.1 –ê` –∏ `U ‚â• 13.5 –í` –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º –≤—ã—Ö–æ–¥–µ | ¬´–ó–∞—Ä—è–¥ –∑–∞–≤–µ—Ä—à—ë–Ω –∏–ª–∏ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä –ø–æ—á—Ç–∏ –ø–æ–ª–æ–Ω¬ª |
| `I = 0 –ê` –±–æ–ª–µ–µ 30 –º–∏–Ω—É—Ç –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º –≤—ã—Ö–æ–¥–µ | ¬´–í—ã—Ö–æ–¥ –≤–∫–ª—é—á–µ–Ω, –Ω–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–±–æ—Ä¬ª |

–ö—É–ª–¥–∞—É–Ω –º–µ–∂–¥—É –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∞–ª–µ—Ä—Ç–∞–º–∏ ‚Äî 1 —á–∞—Å. –û—à–∏–±–∫–∏ —Å–µ—Ç–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –∑–∞–¥–∞—á—É.

---

## ‚ö†Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –£—Å–ª–æ–≤–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|----------|
| **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ê–ö–ë** (sensor.rd_6018_temperature_external) | T‚â•34¬∞C ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (1 —Ä–∞–∑ –∑–∞ —Å–µ—Å—Å–∏—é). T‚â•37¬∞C ‚Üí Output OFF, –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å |
| –î–∞—Ç—á–∏–∫ Unavailable/–æ—à–∏–±–∫–∞ | Output OFF, –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å (–≤—Å–µ —Ä–µ–∂–∏–º—ã) |
| `voltage > 16.6V` | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∂–µ–ª–µ–∑–∞) |
| **Hardware Watchdog** | –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö &gt;5 –º–∏–Ω ‚Üí Output OFF. –ü—Ä–∏ U&gt;15–í –∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö &gt;60 —Å–µ–∫ ‚Üí Output OFF |
| **Soft Watchdog** | –ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏ —Å HA &gt;3 –º–∏–Ω ‚Üí Output OFF |
| **OVP/OCP** | –ü—Ä–∏ —Å–º–µ–Ω–µ —Ñ–∞–∑—ã (Main, Mix, Desulfation): OVP=U+0.2–í, OCP=I+0.5–ê |

–ü–æ—Ä–æ–≥–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã: 34¬∞C (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ), 37¬∞C (–∞–≤–∞—Ä–∏—è). –õ–∏–º–∏—Ç –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –≤ `config.py`: `MAX_VOLTAGE`.

---

## ‚öñÔ∏è –û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª, –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –≥–∞—Ä–∞–Ω—Ç–∏–π. –ê–≤—Ç–æ—Ä—ã –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –≤–æ–∑–º–æ–∂–Ω—ã–π —É—â–µ—Ä–± –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é, –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞–º, –∏–º—É—â–µ—Å—Ç–≤—É –∏–ª–∏ –∑–¥–æ—Ä–æ–≤—å—é, –≤–æ–∑–Ω–∏–∫—à–∏–π –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω–æ–≥–æ –±–æ—Ç–∞. –†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –ø–∏—Ç–∞–Ω–∏—è –∏ –∑–∞—Ä—è–¥–∫–æ–π –ê–ö–ë –Ω–µ—Å—ë—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ —Å–µ–±—è –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é –∏ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Ç–µ—Ö–Ω–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
